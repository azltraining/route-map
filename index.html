<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales Route Pro</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        :root {
            --primary: #00d2ff;
            --dark: #003344;
            --bg: #f4f7f6;
            --card: #ffffff;
            --border: #e2e8f0;
        }

        body.dark-mode {
            --bg: #0f172a;
            --card: #1e293b;
            --border: #334155;
        }

        body { 
            margin: 0; font-family: 'Segoe UI', sans-serif; height: 100vh; 
            display: flex; flex-direction: column; background: var(--bg); overflow: hidden;
        }
        
        #header { 
            background: var(--card); padding: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1001;
            display: flex; flex-direction: column; gap: 8px;
        }

        .top-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        .search-row { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; width: 100%; }

        #searchInput, #statusFilter {
            padding: 10px; border: 1.5px solid var(--border); border-radius: 10px;
            background: var(--bg); color: inherit; font-size: 13px; outline: none;
            width: 100%; box-sizing: border-box;
        }

        .btn-upload { 
            background: var(--dark); color: white; padding: 8px 12px; border-radius: 8px; 
            font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px;
        }

        .icon-btn { 
            background: var(--card); border: 1.5px solid var(--border); width: 38px; height: 38px;
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
        }

        #map { flex: 1; z-index: 1; position: relative; }

        .counter-card {
            position: absolute; top: 10px; left: 10px; background: var(--card);
            padding: 5px 12px; border-radius: 20px; z-index: 1000; font-size: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); border: 1px solid var(--border);
        }

        .side-controls {
            position: absolute; bottom: 30px; right: 15px; display: flex; flex-direction: column; gap: 12px; z-index: 1000;
        }

        .action-btn {
            width: 54px; height: 54px; background: var(--card); border-radius: 15px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: none; font-size: 22px;
        }

        /* Marker Pin */
        .marker-pin { width: 28px; height: 28px; border-radius: 50% 50% 50% 0; position: absolute; transform: rotate(-45deg); left: 50%; top: 50%; margin: -14px 0 0 -14px; border: 2px solid white; }
        .marker-pin::after { content: ''; width: 12px; height: 12px; margin: 8px 0 0 8px; background: white; position: absolute; border-radius: 50%; }

        /* Popup */
        .waze-btn { display: block; background: #31CCFF; color: white !important; text-align: center; padding: 10px; border-radius: 8px; text-decoration: none; margin-top: 10px; font-weight: bold; }
        .visit-btn { width: 100%; background: #00b894; color: white; border: none; padding: 10px; border-radius: 8px; margin-top: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div id="header">
    <div class="top-row">
        <label class="btn-upload">
            <i class="fa-solid fa-file-csv"></i> CSV
            <input type="file" id="csvFile" style="display:none" accept=".csv">
        </label>
        <div style="display: flex; gap: 6px;">
            <button class="icon-btn" onclick="exportReport()"><i class="fa-solid fa-download"></i></button>
            <button class="icon-btn" onclick="toggleDarkMode()"><i class="fa-solid fa-moon"></i></button>
            <button class="icon-btn" onclick="clearData()"><i class="fa-solid fa-trash"></i></button>
        </div>
    </div>
    
    <div class="search-row">
        <input type="text" id="searchInput" placeholder="Axtarƒ±≈ü..." disabled>
        <select id="statusFilter" onchange="filterMarkers()" disabled>
            <option value="all">Hamƒ±sƒ±</option>
            <option value="plan">üìç Plan</option>
            <option value="visited">‚úÖ Bitdi</option>
            <option value="pending">‚ö™ G√∂zl…ôy…ôn</option>
        </select>
    </div>
</div>

<div id="map">
    <div id="counterCard" class="counter-card" style="display:none">
        <span id="totalCount">0</span> m…ônt…ôq…ô
    </div>
    <div class="side-controls">
        <button class="action-btn" style="background: var(--dark); color: white;" onclick="findNearestPending()"><i class="fa-solid fa-tower-broadcast"></i></button>
        <button class="action-btn" style="color: #e74c3c;" onclick="findMe()"><i class="fa-solid fa-crosshairs"></i></button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
    let userLocation = null;
    let userMarker = null;
    let isDarkMode = localStorage.getItem('darkMode') === 'true';
    const markersLayer = L.layerGroup();
    let dataPoints = [];
    let rawCsvData = [];
    let visitHistory = JSON.parse(localStorage.getItem('visitHistory')) || {};
    let dailyPlan = JSON.parse(localStorage.getItem('dailyPlan')) || {};

    const map = L.map('map', { zoomControl: false }).setView([40.4093, 49.8671], 9);
    const lightTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
    (isDarkMode ? darkTiles : lightTiles).addTo(map);
    markersLayer.addTo(map);

    if (isDarkMode) document.body.classList.add('dark-mode');

    function createColoredIcon(color) {
        return L.divIcon({
            className: 'custom-div-icon',
            html: `<div style="background-color:${color};" class="marker-pin"></div>`,
            iconSize: [30, 42], iconAnchor: [15, 42]
        });
    }

    function findMe() {
        map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
    }

    map.on('locationfound', (e) => {
        userLocation = e.latlng;
        if (!userMarker) {
            userMarker = L.circleMarker(e.latlng, { radius: 8, color: '#fff', weight: 3, fillOpacity: 1, fillColor: '#0984e3' }).addTo(map);
        } else {
            userMarker.setLatLng(e.latlng);
        }
        filterMarkers();
    });

    document.getElementById('csvFile').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        Papa.parse(file, {
            header: true, skipEmptyLines: true,
            complete: (results) => {
                rawCsvData = results.data;
                processData(rawCsvData, true);
            }
        });
    };

    function processData(data, shouldSave) {
        markersLayer.clearLayers();
        dataPoints = [];
        if (shouldSave) localStorage.setItem('lastCsvData', JSON.stringify(data));

        data.forEach(row => {
            const lat = parseFloat(row['Latitude']?.toString().replace(',', '.'));
            const lng = parseFloat(row['Longitude']?.toString().replace(',', '.'));
            if (!isNaN(lat) && !isNaN(lng)) {
                const id = row['SubRetailer Draw ID'] || 'N/A';
                let color = visitHistory[id] ? '#00b894' : (dailyPlan[id] ? '#fdcb6e' : '#0984e3');
                const marker = L.marker([lat, lng], { icon: createColoredIcon(color) });
                marker.pointData = { ...row, lat, lng, id };
                marker.on('click', () => showMarkerPopup(marker));
                dataPoints.push(marker);
                marker.addTo(markersLayer);
            }
        });
        if (dataPoints.length > 0) {
            map.fitBounds(new L.featureGroup(dataPoints).getBounds(), { padding: [30, 30] });
            document.getElementById('searchInput').disabled = false;
            document.getElementById('statusFilter').disabled = false;
            document.getElementById('totalCount').innerText = dataPoints.length;
            document.getElementById('counterCard').style.display = 'block';
        }
    }

    function showMarkerPopup(marker) {
        const p = marker.pointData;
        const isPlanned = dailyPlan[p.id];
        const content = `
            <div style="text-align:center">
                <b>${p['District'] || 'Maƒüaza'}</b><br>
                <small>ID: ${p.id}</small>
                <a href="https://waze.com/ul?ll=${p.lat},${p.lng}&navigate=yes" class="waze-btn">Waze</a>
                <button onclick="markAsVisited('${p.id}')" class="visit-btn">Bitir</button>
                <button onclick="togglePlan('${p.id}')" style="width:100%; margin-top:5px; padding:8px; border-radius:8px; border:1px solid #ccc">
                    ${isPlanned ? 'Plandan √áƒ±xar' : 'Plana ∆èlav…ô Et'}
                </button>
            </div>
        `;
        L.popup().setLatLng(marker.getLatLng()).setContent(content).openOn(map);
    }

    window.markAsVisited = (id) => {
        visitHistory[id] = true;
        localStorage.setItem('visitHistory', JSON.stringify(visitHistory));
        location.reload();
    };

    window.togglePlan = (id) => {
        if (dailyPlan[id]) delete dailyPlan[id]; else dailyPlan[id] = true;
        localStorage.setItem('dailyPlan', JSON.stringify(dailyPlan));
        location.reload();
    };

    function filterMarkers() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const filter = document.getElementById('statusFilter').value;
        markersLayer.clearLayers();
        dataPoints.filter(m => {
            const id = m.pointData.id;
            const matchSearch = id.toLowerCase().includes(search) || (m.pointData['District'] || '').toLowerCase().includes(search);
            let matchStatus = true;
            if (filter === 'visited') matchStatus = visitHistory[id];
            else if (filter === 'plan') matchStatus = dailyPlan[id];
            else if (filter === 'pending') matchStatus = !visitHistory[id];
            if (matchSearch && matchStatus) m.addTo(markersLayer);
        });
    }

    function findNearestPending() {
        if (!userLocation) return findMe();
        let pending = dataPoints.filter(m => !visitHistory[m.pointData.id]);
        if (pending.length === 0) return;
        pending.sort((a,b) => map.distance(a.getLatLng(), userLocation) - map.distance(b.getLatLng(), userLocation));
        map.setView(pending[0].getLatLng(), 16);
        showMarkerPopup(pending[0]);
    }

    function toggleDarkMode() {
        isDarkMode = !isDarkMode;
        localStorage.setItem('darkMode', isDarkMode);
        location.reload();
    }

    function clearData() { if(confirm("M…ôlumatlar silinsin?")) { localStorage.clear(); location.reload(); } }
    document.getElementById('searchInput').oninput = filterMarkers;
    const saved = localStorage.getItem('lastCsvData');
    if (saved) processData(JSON.parse(saved), false);
</script>
</body>
</html>
