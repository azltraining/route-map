<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root { --p: #003344; --s: #fdcb6e; --v: #00b894; --bg: #f4f7f6; --c: #ffffff; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; height: -webkit-fill-available; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); }
        body { display: flex; flex-direction: column; min-height: 100vh; }
        #header { background: var(--c); padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1001; flex-shrink: 0; }
        .row { display: flex; gap: 6px; align-items: center; margin-bottom: 8px; width: 100%; }
        .row:last-child { margin-bottom: 0; }
        .stat-badge { background: #eee; padding: 4px 8px; border-radius: 15px; font-size: 11px; font-weight: bold; color: var(--p); white-space: nowrap; }
        input { flex: 1.5; padding: 10px; border: 1.5px solid #e0e0e0; border-radius: 8px; font-size: 13px; outline: none; }
        select { flex: 1; padding: 10px; border: 1.5px solid #e0e0e0; border-radius: 8px; font-size: 13px; outline: none; background: #fff; cursor: pointer; }
        .btn-csv { background: var(--p); color: white; padding: 10px 14px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 4px; border: none; }
        .icon-btn { border: 1.5px solid #e0e0e0; background: white; width: 38px; height: 38px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--p); flex-shrink: 0; cursor: pointer; }
        .btn-route { background: #6c5ce7; color: white; padding: 10px 14px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; border: none; }
        .btn-clear-plan { background: #e67e22; color: white; border: none; width: 38px; height: 38px; border-radius: 8px; cursor: pointer; }
        #map { flex-grow: 1; width: 100%; position: relative; z-index: 1; }
        
        .copyright-tag { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(255, 255, 255, 0.85); padding: 5px 15px; border-radius: 20px; font-size: 11px; color: #333; font-weight: bold; pointer-events: none; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #ddd; }

        .marker-pin { width: 32px; height: 32px; border-radius: 50% 50% 50% 0; position: absolute; transform: rotate(-45deg); left: 50%; top: 50%; margin: -16px 0 0 -16px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; }
        .marker-pin span { transform: rotate(45deg); color: #000; font-weight: bold; font-size: 13px; pointer-events: none; }
        
        .pop-card { text-align: center; min-width: 170px; padding: 5px; }
        .pop-card b { font-size: 14px; color: var(--p); display: block; margin-bottom: 2px; }
        .dist-info { background: #f0f7ff; color: #007aff; padding: 5px; border-radius: 6px; font-weight: bold; margin-bottom: 8px; font-size: 10px; line-height: 1.3; }
        .action-grid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 10px; }
        .btn-s { border: none; padding: 10px; border-radius: 6px; font-weight: bold; font-size: 12px; color: white; cursor: pointer; width: 100%; }
        
        .custom-wrapper { position: relative; display: none; align-items: center; flex: 1; }
        .custom-wrapper input { width: 100%; padding-right: 30px; border-color: #6c5ce7; }
        .back-btn { position: absolute; right: 8px; cursor: pointer; color: #ff7675; font-weight: bold; font-size: 16px; padding: 5px; }
    </style>
</head>
<body>

<div id="header">
    <div class="row">
        <label class="btn-csv"><i class="fa-solid fa-file-upload"></i> CSV <input type="file" id="csvFile" style="display:none" accept=".csv"></label>
        
        <div style="display: flex; gap: 4px; flex: 1;">
            <select id="startPoint" onchange="checkCustom('start')">
                <option value="" disabled selected hidden>Başlanğıc</option>
                <option value="40.376407,49.862726">Ofis</option>
                <option value="40.379146,49.861340">Parking</option>
                <option value="40.396275,49.816170">Fortuna</option>
                <option value="custom">Xüsusi...</option>
            </select>
            <div id="startWrap" class="custom-wrapper">
                <input type="text" id="startCustom" placeholder="Lat, Lng" oninput="updateRouteCalculations()">
                <span class="back-btn" onclick="resetSelect('start')">✕</span>
            </div>
        </div>

        <div style="display: flex; gap: 4px; flex: 1;">
            <select id="endPoint" onchange="checkCustom('end')">
                <option value="" disabled selected hidden>Dayanacaq</option>
                <option value="40.412483,49.986298">Elman</option>
                <option value="40.412663,49.818919">Murad</option>
                <option value="40.452347,49.779457">Səxavət</option>
                <option value="custom">Xüsusi...</option>
            </select>
            <div id="endWrap" class="custom-wrapper">
                <input type="text" id="endCustom" placeholder="Lat, Lng" oninput="updateRouteCalculations()">
                <span class="back-btn" onclick="resetSelect('end')">✕</span>
            </div>
        </div>

        <button class="btn-route" onclick="showMyRoute()">Yolu Göstər</button>
        <button class="btn-clear-plan" onclick="clearCurrentPlan()" title="Planı Təmizlə"><i class="fa-solid fa-calendar-xmark"></i></button>
        <button class="icon-btn" onclick="clearData()" title="Sıfırla"><i class="fa-solid fa-trash-can"></i></button>
    </div>
    <div class="row">
        <div class="stat-badge" id="counter">Say: 0</div>
        <input type="text" id="search" placeholder="Axtar (Ad və ya ID)...">
        <select id="filter" onchange="filterM()">
            <option value="all">Hamısı</option>
            <option value="plan">Gediləcək</option>
        </select>
    </div>
</div>

<div id="map">
    <div class="copyright-tag">© This application created by Elman Huseynov</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
    let uL = null, eL = null, mLayer = L.layerGroup(), dPts = [];
    let dP = JSON.parse(localStorage.getItem('dP')) || {}; 
    let isRouteCalculated = false;

    function checkCustom(type) {
        const sel = document.getElementById(type + 'Point');
        const wrap = document.getElementById(type + 'Wrap');
        if (sel.value === 'custom') {
            sel.style.display = 'none';
            wrap.style.display = 'flex';
        }
        updateRouteCalculations();
    }

    function resetSelect(type) {
        const sel = document.getElementById(type + 'Point');
        const wrap = document.getElementById(type + 'Wrap');
        sel.value = "";
        sel.style.display = 'block';
        wrap.style.display = 'none';
        document.getElementById(type + 'Custom').value = "";
        updateRouteCalculations();
    }

    function setPoints() {
        const getCoord = (t) => {
            const sel = document.getElementById(t + 'Point');
            if(sel.value === 'custom') return document.getElementById(t + 'Custom').value;
            return sel.value;
        };
        const sVal = getCoord('start') || "40.379,49.861";
        const eVal = getCoord('end') || "40.412,49.986";
        try {
            const sC = sVal.split(','), eC = eVal.split(',');
            uL = L.latLng(parseFloat(sC[0]), parseFloat(sC[1]));
            eL = L.latLng(parseFloat(eC[0]), parseFloat(eC[1]));
        } catch(e) {}
    }

    const map = L.map('map', {zoomControl: false, attributionControl: false}).setView([40.4, 49.8], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    mLayer.addTo(map);

    document.getElementById('csvFile').onchange = (e) => {
        const f = e.target.files[0]; if(!f) return;
        Papa.parse(f, {
            header: true, skipEmptyLines: true, encoding: "UTF-8", 
            complete: (r) => { process(r.data, true); }
        });
    };

    function process(data, s) {
        mLayer.clearLayers(); dPts.length = 0;
        if(s) localStorage.setItem('lastC', JSON.stringify(data));
        setPoints();
        
        const planList = data.filter(x => dP[x['SubRetailer Draw ID']]);
        let opt = []; 

        if(planList.length > 0) {
            let rem = planList.map(item => ({
                ...item, pos: L.latLng(parseFloat(item.Latitude?.replace(',','.')), parseFloat(item.Longitude?.replace(',','.')))
            }));

            // 1. ADDIM: Başlanğıc nöqtəsinə (uL) ƏN UZAQ olan mağazanı tapırıq
            rem.sort((a, b) => map.distance(uL, b.pos) - map.distance(uL, a.pos));
            let firstNode = rem.shift();
            opt.push(firstNode);
            let cur = firstNode.pos;

            // 2. ADDIM: Qalan mağazaları dayanacağa (eL) yaxınlaşmaq şərti ilə sıralayırıq
            while(rem.length > 0) {
                rem.sort((a, b) => {
                    let dToNextA = map.distance(cur, a.pos);
                    let dToNextB = map.distance(cur, b.pos);
                    let dToFinalA = map.distance(eL, a.pos);
                    let dToFinalB = map.distance(eL, b.pos);
                    
                    // Həm cari nöqtəyə yaxın olsun, həm də son hədəfə (eL) meyillənsin
                    return (dToNextA + dToFinalA) - (dToNextB + dToFinalB);
                });
                let next = rem.shift();
                opt.push(next);
                cur = next.pos;
            }
        }

        data.forEach(r => {
            const lat = parseFloat(r.Latitude?.replace(',','.')), lng = parseFloat(r.Longitude?.replace(',','.'));
            if(!isNaN(lat) && !isNaN(lng)) {
                const id = r['SubRetailer Draw ID'], isP = dP[id];
                const col = isP ? '#fdcb6e' : '#0984e3';
                let n = ""; 
                if(isP && isRouteCalculated) {
                    let i = opt.findIndex(x => x['SubRetailer Draw ID'] === id);
                    if(i!==-1) n = `<span>${i+1}</span>`;
                }
                const m = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className:'', html:`<div style="background:${col}" class="marker-pin">${n}</div>`, 
                        iconSize:[32,48], iconAnchor:[16,48], popupAnchor:[0,-45]
                    })
                });
                m.pData = {...r, id}; 
                m.on('click', () => showP(m)); 
                dPts.push(m);
            }
        });
        filterM();
        if(s && dPts.length) map.fitBounds(new L.featureGroup(dPts).getBounds());
    }

    function showP(m) {
        const p = m.pData, id = p.id, isP = dP[id];
        let d = (isRouteCalculated && isP) ? 
            `<div class="dist-info">Startdan: ${(map.distance(m.getLatLng(), uL)/1000).toFixed(1)}km | Sona: ${(map.distance(m.getLatLng(), eL)/1000).toFixed(1)}km</div>` : "";
        
        const h = `
            <div class="pop-card">
                <b>${p.District || 'Məntəqə'}</b>
                <div style="font-size:11px; margin-bottom:5px;">ID: ${id}</div>
                ${d}
                <div class="action-grid">
                    <button onclick="tP('${id}')" class="btn-s" style="background:${isP ? '#e67e22' : '#fdcb6e'}; color:#000">
                        ${isP ? 'Plandan sil' : 'Plana sal'}
                    </button>
                </div>
            </div>`;
        L.popup().setLatLng(m.getLatLng()).setContent(h).openOn(map);
    }

    window.tP = (id) => { 
        if(dP[id]) delete dP[id]; else dP[id] = true; 
        isRouteCalculated = false; 
        localStorage.setItem('dP', JSON.stringify(dP)); 
        map.closePopup(); refreshMap(); 
    };

    window.showMyRoute = () => { 
        if(Object.keys(dP).length===0) return alert("Planda mağaza yoxdur!"); 
        isRouteCalculated = true; 
        refreshMap(); 
        document.getElementById('filter').value = 'plan'; 
        filterM(); 
    };

    window.updateRouteCalculations = () => { isRouteCalculated = false; setPoints(); refreshMap(); };

    function refreshMap() { 
        const z = map.getZoom(), c = map.getCenter(), l = localStorage.getItem('lastC'); 
        if(l) process(JSON.parse(l), false); 
        map.setView(c, z); 
    }

    function filterM() {
        const s = document.getElementById('search').value.toLowerCase();
        const f = document.getElementById('filter').value;
        mLayer.clearLayers();
        let visibleCount = 0;

        dPts.forEach(m => {
            const id = m.pData.id.toLowerCase();
            const name = (m.pData.District || "").toLowerCase();
            const isP = dP[m.pData.id];

            const matchSearch = id.includes(s) || name.includes(s);
            let matchFilter = (f === 'all') || (f === 'plan' && isP);

            if(matchSearch && matchFilter) {
                m.addTo(mLayer);
                visibleCount++;
            }
        });
        document.getElementById('counter').innerText = `Say: ${visibleCount}`;
    }

    window.clearCurrentPlan = () => { 
        if(confirm("Bütün plan silinsin?")) { 
            dP = {}; isRouteCalculated = false; 
            localStorage.setItem('dP', JSON.stringify(dP)); 
            refreshMap(); 
        } 
    };

    function clearData() { if(confirm("Sistem sıfırlansın?")) { localStorage.clear(); location.reload(); } }
    
    document.getElementById('search').addEventListener('input', filterM);

    const savedData = localStorage.getItem('lastC');
    if(savedData) process(JSON.parse(savedData), false); else setPoints();
</script>
</body>
</html>
