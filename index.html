<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root { --p: #003344; --s: #fdcb6e; --v: #00b894; --bg: #f4f7f6; --c: #ffffff; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); }
        body { display: flex; flex-direction: column; min-height: 100vh; }
        #header { background: var(--c); padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1001; }
        .row { display: flex; gap: 6px; align-items: center; margin-bottom: 8px; }
        .stat-badge { background: #eee; padding: 4px 8px; border-radius: 15px; font-size: 11px; font-weight: bold; color: var(--p); }
        input, select { flex: 1; padding: 10px; border: 1.5px solid #e0e0e0; border-radius: 8px; font-size: 13px; outline: none; }
        .btn-csv { background: var(--p); color: white; padding: 10px 14px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; border: none; }
        .btn-route { background: #6c5ce7; color: white; padding: 10px 14px; border-radius: 8px; font-size: 12px; font-weight: bold; border: none; }
        .icon-btn { border: 1.5px solid #e0e0e0; background: white; width: 38px; height: 38px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        #map { flex-grow: 1; width: 100%; position: relative; }
        .copyright-tag { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(255, 255, 255, 0.85); padding: 5px 15px; border-radius: 20px; font-size: 11px; font-weight: bold; border: 1px solid #ddd; }
        .marker-pin { width: 32px; height: 32px; border-radius: 50% 50% 50% 0; position: absolute; transform: rotate(-45deg); left: 50%; top: 50%; margin: -16px 0 0 -16px; border: 2px solid white; display: flex; align-items: center; justify-content: center; }
        .marker-pin span { transform: rotate(45deg); color: #000; font-weight: bold; font-size: 13px; }
        .pop-card { text-align: center; min-width: 170px; }
        .btn-s { border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
    </style>
</head>
<body>

<div id="header">
    <div class="row">
        <label class="btn-csv"><i class="fa-solid fa-file-upload"></i> CSV <input type="file" id="csvFile" style="display:none" accept=".csv"></label>
        <select id="startPoint"><option value="40.379146,49.861340">Parking</option></select>
        <select id="endPoint"><option value="40.412483,49.986298">Elman</option></select>
        <button class="btn-route" onclick="showMyRoute()">Yolu Göstər</button>
        <button class="icon-btn" onclick="clearData()"><i class="fa-solid fa-trash-can"></i></button>
    </div>
    <div class="row">
        <div class="stat-badge" id="counter">Say: 0</div>
        <input type="text" id="search" placeholder="Axtar...">
        <select id="filter" onchange="filterM()"><option value="all">Hamısı</option><option value="plan">Gediləcək</option></select>
    </div>
</div>

<div id="map"><div class="copyright-tag">©This application created by Elman Huseynov</div></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
    let eL = null, mLayer = L.layerGroup(), dPts = [];
    let dP = JSON.parse(localStorage.getItem('dP')) || {}; 
    let isRouteCalculated = false;

    const map = L.map('map', {zoomControl: false, attributionControl: false}).setView([40.4, 49.8], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    mLayer.addTo(map);

    function setPoints() {
        const eVal = document.getElementById('endPoint').value;
        const eC = eVal.split(',');
        eL = L.latLng(parseFloat(eC[0]), parseFloat(eC[1]));
    }

    document.getElementById('csvFile').onchange = (e) => {
        const f = e.target.files[0]; if(!f) return;
        Papa.parse(f, { header: true, skipEmptyLines: true, complete: (r) => { process(r.data, true); } });
    };

    function process(data, s) {
        mLayer.clearLayers(); dPts.length = 0;
        if(s) localStorage.setItem('lastC', JSON.stringify(data));
        setPoints();
        
        const planList = data.filter(x => dP[x['SubRetailer Draw ID']]);
        let opt = []; 

        if(planList.length > 0) {
            opt = planList.map(item => ({
                ...item, pos: L.latLng(parseFloat(item.Latitude?.replace(',','.')), parseFloat(item.Longitude?.replace(',','.')))
            }));
            // EVƏ ƏN UZAQDAN EVƏ ƏN YAXINA DOĞRU SIRALAMA
            opt.sort((a, b) => map.distance(eL, b.pos) - map.distance(eL, a.pos));
        }

        data.forEach(r => {
            const lat = parseFloat(r.Latitude?.replace(',','.')), lng = parseFloat(r.Longitude?.replace(',','.'));
            if(!isNaN(lat) && !isNaN(lng)) {
                const id = r['SubRetailer Draw ID'], isP = dP[id];
                const col = isP ? '#fdcb6e' : '#0984e3';
                let n = ""; 
                if(isP && isRouteCalculated) {
                    let i = opt.findIndex(x => x['SubRetailer Draw ID'] === id);
                    if(i!==-1) n = `<span>${i+1}</span>`;
                }
                const m = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className:'', html:`<div style="background:${col}" class="marker-pin">${n}</div>`, 
                        iconSize:[32,48], iconAnchor:[16,48], popupAnchor:[0,-45]
                    })
                });
                m.pData = {...r, id}; 
                m.on('click', () => showP(m)); 
                dPts.push(m);
            }
        });
        filterM();
    }

    function showP(m) {
        const p = m.pData, id = p.id, isP = dP[id];
        const h = `<div class="pop-card"><b>${p.District}</b><br>ID: ${id}<button onclick="tP('${id}')" class="btn-s" style="background:${isP ? '#e67e22' : '#fdcb6e'}">${isP ? 'Plandan sil' : 'Plana sal'}</button></div>`;
        L.popup().setLatLng(m.getLatLng()).setContent(h).openOn(map);
    }

    window.tP = (id) => { 
        if(dP[id]) delete dP[id]; else dP[id] = true; 
        isRouteCalculated = false; localStorage.setItem('dP', JSON.stringify(dP)); 
        map.closePopup(); refreshMap(); 
    };

    window.showMyRoute = () => { isRouteCalculated = true; refreshMap(); };
    function refreshMap() { const l = localStorage.getItem('lastC'); if(l) process(JSON.parse(l), false); }
    function filterM() {
        const s = document.getElementById('search').value.toLowerCase();
        const f = document.getElementById('filter').value;
        mLayer.clearLayers();
        let c = 0;
        dPts.forEach(m => {
            const match = (m.pData.id.toLowerCase().includes(s) || (m.pData.District || "").toLowerCase().includes(s)) && (f === 'all' || (f === 'plan' && dP[m.pData.id]));
            if(match) { m.addTo(mLayer); c++; }
        });
        document.getElementById('counter').innerText = "Say: " + c;
    }
    function clearData() { if(confirm("Sıfırlansın?")) { localStorage.clear(); location.reload(); } }
    document.getElementById('search').addEventListener('input', filterM);
    const saved = localStorage.getItem('lastC');
    if(saved) process(JSON.parse(saved), false);
</script>
</body>
</html>
