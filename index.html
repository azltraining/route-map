<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root { --p: #003344; --s: #fdcb6e; --v: #00b894; --bg: #f4f7f6; --c: #ffffff; }

        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            height: -webkit-fill-available; overflow: hidden; 
            font-family: 'Segoe UI', sans-serif; background: var(--bg);
        }

        body { display: flex; flex-direction: column; min-height: 100vh; min-height: -webkit-fill-available; }
        
        #header { 
            background: var(--c); padding: 10px 10px 12px 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1001; flex-shrink: 0; 
        }
        .row { display: flex; gap: 6px; align-items: center; margin-bottom: 8px; width: 100%; }
        .row:last-child { margin-bottom: 0; }
        
        .stat-badge { background: #eee; padding: 4px 8px; border-radius: 15px; font-size: 11px; font-weight: bold; color: var(--p); white-space: nowrap; }
        input { flex: 1.5; padding: 10px; border: 1.5px solid #e0e0e0; border-radius: 8px; font-size: 13px; outline: none; min-width: 0; -webkit-appearance: none; }
        select { flex: 1; padding: 10px; border: 1.5px solid #e0e0e0; border-radius: 8px; font-size: 13px; outline: none; background-color: #fff; cursor: pointer; -webkit-appearance: none; }
        
        .btn-csv { background: var(--p); color: white; padding: 10px 14px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
        .icon-btn { border: 1.5px solid #e0e0e0; background: white; width: 38px; height: 38px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; color: var(--p); flex-shrink: 0; }
        .btn-route { background: #6c5ce7; color: white; padding: 10px 14px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 4px; border: none; }
        .btn-clear-plan { background: #e67e22; color: white; border: none; padding: 10px; border-radius: 8px; font-size: 16px; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }

        #map { flex-grow: 1; width: 100%; position: relative; z-index: 1; }

        .copyright-overlay { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(255, 255, 255, 0.85); padding: 4px 12px; border-radius: 20px; font-size: 10px; color: #333; font-weight: 500; pointer-events: none; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .marker-pin { width: 28px; height: 28px; border-radius: 50% 50% 50% 0; position: absolute; transform: rotate(-45deg); left: 50%; top: 50%; margin: -14px 0 0 -14px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .route-num { position: absolute; top: -18px; left: 50%; transform: translateX(-50%); background: var(--p); color: white; border-radius: 10px; padding: 1px 6px; font-size: 10px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3); border: 1px solid white; z-index: 1000; }
        
        .pop-card { text-align: center; min-width: 170px; }
        .pop-card b { font-size: 15px; color: var(--p); display: block; margin-bottom: 2px; }
        .pop-info { font-size: 11px; color: #666; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 6px; }
        .dist-info { background: #f0f7ff; color: #007aff; padding: 4px; border-radius: 6px; font-weight: bold; margin-bottom: 6px; font-size: 10px; }
        .waze-btn { background: #31CCFF; color: white !important; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px; border-radius: 8px; font-weight: bold; margin-top: 6px; font-size: 13px; }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 8px; }
        .btn-s { border: none; padding: 8px; border-radius: 6px; font-weight: bold; font-size: 10px; color: white; cursor: pointer; }
    </style>
</head>
<body>

<div id="header">
    <div class="row">
        <label class="btn-csv"><i class="fa-solid fa-file-upload"></i> CSV <input type="file" id="csvFile" style="display:none" accept=".csv"></label>
        
        <select id="startPoint" onchange="updateRouteCalculations()" style="max-width: 200px; border: 1.5px solid #6c5ce7; font-weight: bold;">
            <option value="40.37640719466837,49.86272695730056">Ofis</option>
            <option value="40.3791468082409,49.86134006965304">Parking</option>
            <option value="40.39627503668952,49.81617022857304">Fortuna Baş ofis</option>
        </select>

        <button class="btn-route" onclick="showMyRoute()"><i class="fa-solid fa-route"></i> Yolu Göstər</button>
        
        <div style="flex:1"></div>
        <button class="btn-clear-plan" onclick="clearCurrentPlan()" title="Planı Təmizlə"><i class="fa-solid fa-calendar-xmark"></i></button>
        <button class="icon-btn" onclick="exportReport()" title="Hesabat Yüklə"><i class="fa-solid fa-file-export"></i></button>
        <button class="icon-btn" onclick="clearData()" title="Sıfırla"><i class="fa-solid fa-trash-can"></i></button>
    </div>
    <div class="row">
        <div class="stat-badge" id="counter">Say: 0</div>
        <input type="text" id="search" placeholder="Axtar..." disabled>
        <select id="filter" onchange="filterM()" disabled>
            <option value="all">Hamısı</option>
            <option value="plan">Gediləcək (plan)</option>
            <option value="visited">Ziyarət edildi</option>
            <option value="pending">Gözləyənlər</option>
        </select>
    </div>
</div>

<div id="map">
    <div class="copyright-overlay">© This application is created by AZL Training</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
    let uL = null, uM = null, mLayer = L.layerGroup(), dPts = [];
    let vH = JSON.parse(localStorage.getItem('vH')) || {}; 
    let dP = JSON.parse(localStorage.getItem('dP')) || {}; 

    // İlkin olaraq seçilmiş başlanğıc nöqtəsini uL (User Location) kimi təyin edirik
    function setInitialLocation() {
        const coords = document.getElementById('startPoint').value.split(',');
        uL = L.latLng(parseFloat(coords[0]), parseFloat(coords[1]));
    }

    function updateRouteCalculations() {
        setInitialLocation();
        refreshMap();
    }

    const map = L.map('map', {zoomControl: false, attributionControl: false}).setView([40.4, 49.8], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    mLayer.addTo(map);

    document.getElementById('csvFile').onchange = (e) => {
        const f = e.target.files[0]; if(!f) return;
        Papa.parse(f, {header: true, skipEmptyLines: true, complete: (r) => { process(r.data, true); }});
    };

    function process(data, s) {
        mLayer.clearLayers(); dPts.length = 0;
        if(s) localStorage.setItem('lastC', JSON.stringify(data));
        
        // Başlanğıc nöqtəsini götürürük
        setInitialLocation();

        data.forEach(r => {
            const lat = parseFloat(r.Latitude?.replace(',','.')), lng = parseFloat(r.Longitude?.replace(',','.'));
            if(!isNaN(lat) && !isNaN(lng)) {
                const id = r['SubRetailer Draw ID'];
                const isP = dP[id], isV = vH[id];
                const col = isV ? '#00b894' : (isP ? '#fdcb6e' : '#0984e3');
                
                let numHtml = "";
                if(isP && !isV) {
                    // Planda olanları başlanğıc nöqtəsinə görə sıralayırıq
                    let currentPlan = data.filter(x => dP[x['SubRetailer Draw ID']] && !vH[x['SubRetailer Draw ID']]);
                    currentPlan.sort((a,b) => {
                        let posA = L.latLng(parseFloat(a.Latitude?.replace(',','.')), parseFloat(a.Longitude?.replace(',','.')));
                        let posB = L.latLng(parseFloat(b.Latitude?.replace(',','.')), parseFloat(b.Longitude?.replace(',','.')));
                        return map.distance(uL, posA) - map.distance(uL, posB);
                    });
                    let idx = currentPlan.findIndex(x => x['SubRetailer Draw ID'] === id);
                    if(idx !== -1) numHtml = `<b class="route-num">${idx + 1}</b>`;
                }

                const mIcon = L.divIcon({
                    className: '', 
                    html: `<div style="background:${col}" class="marker-pin"></div>${numHtml}`, 
                    iconSize: [30, 42],
                    iconAnchor: [15, 42],
                    popupAnchor: [0, -40]
                });

                const m = L.marker([lat, lng], { icon: mIcon });
                m.pData = { ...r, id };
                m.on('click', () => showP(m));
                dPts.push(m); m.addTo(mLayer);
            }
        });
        
        document.getElementById('counter').innerText = `Say: ${dPts.length}`;
        if(dPts.length) {
            document.getElementById('search').disabled = false; 
            document.getElementById('filter').disabled = false;
            if(s) map.fitBounds(new L.featureGroup(dPts).getBounds());
        }
    }

    function showP(m) {
        const p = m.pData, id = p.id;
        const isP = dP[id], isV = vH[id];
        const lastDate = isV ? vH[id] : "Yoxdur";
        let distText = `<div class="dist-info">Başlanğıcdan: ${(map.distance(m.getLatLng(), uL) / 1000).toFixed(2)} km</div>`;

        const h = `
            <div class="pop-card">
                <b>${p.District || 'Adsız'}</b>
                <div class="pop-info">ID: ${id}<br>Son: ${lastDate}</div>
                ${distText}
                <div class="action-grid">
                    <button onclick="mV('${id}')" class="btn-s" style="background:#00b894">Bitir</button>
                    <button onclick="tP('${id}')" class="btn-s" style="background:#fdcb6e; color:#333">${isP ? 'Çıx' : 'Plana sal'}</button>
                </div>
                <a href="waze://?ll=${p.Latitude},${p.Longitude}&navigate=yes" class="waze-btn"><i class="fa-brands fa-waze"></i> WAZE</a>
            </div>`;
        L.popup().setLatLng(m.getLatLng()).setContent(h).openOn(map);
    }

    window.mV = (id) => {
        vH[id] = new Date().toLocaleString('az-AZ');
        localStorage.setItem('vH', JSON.stringify(vH));
        refreshMap();
    };

    window.tP = (id) => {
        if(dP[id]) delete dP[id]; else dP[id] = true;
        localStorage.setItem('dP', JSON.stringify(dP));
        refreshMap();
    };

    window.clearCurrentPlan = () => {
        const count = Object.keys(dP).length;
        if(count === 0) return alert("Planda təmizlənəcək nöqtə yoxdur.");
        if(confirm(`Plandakı ${count} nöqtə silinsin?`)) {
            dP = {}; 
            localStorage.setItem('dP', JSON.stringify(dP));
            refreshMap();
        }
    };

    function refreshMap() {
        const curZoom = map.getZoom(), curCenter = map.getCenter();
        const lastData = localStorage.getItem('lastC');
        if(lastData) process(JSON.parse(lastData), false);
        map.setView(curCenter, curZoom);
        map.closePopup();
    }

    function filterM() {
        const s = document.getElementById('search').value.toLowerCase();
        const f = document.getElementById('filter').value;
        mLayer.clearLayers();
        let count = 0;
        dPts.forEach(m => {
            const id = m.pData.id.toLowerCase(), name = (m.pData.District || "").toLowerCase();
            const matchS = id.includes(s) || name.includes(s);
            let matchF = (f === 'all') || (f === 'plan' && dP[m.pData.id]) || (f === 'visited' && vH[m.pData.id]) || (f === 'pending' && !vH[m.pData.id]);
            if(matchS && matchF) { m.addTo(mLayer); count++; }
        });
        document.getElementById('counter').innerText = `Say: ${count}`;
    }

    window.showMyRoute = () => {
        let plan = dPts.filter(m => dP[m.pData.id] && !vH[m.pData.id]);
        if(plan.length === 0) return alert("Planda nöqtə yoxdur!");
        document.getElementById('filter').value = 'plan';
        filterM();
        // Cari seçilmiş başlanğıc nöqtəsinə görə sıralama
        plan.sort((a,b) => map.distance(a.getLatLng(), uL) - map.distance(b.getLatLng(), uL));
        map.setView(plan[0].getLatLng(), 15);
        showP(plan[0]);
    };

    window.exportReport = () => {
        if(Object.keys(vH).length === 0) return alert("Ziyarət yoxdur!");
        let csv = "data:text/csv;charset=utf-8,ID,Mağaza,Ziyarət Vaxtı\n";
        const data = JSON.parse(localStorage.getItem('lastC') || "[]");
        Object.keys(vH).forEach(id => {
            const shop = data.find(item => item['SubRetailer Draw ID'] === id);
            csv += `${id},${shop ? shop.District : "Naməlum"},${vH[id]}\n`;
        });
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csv));
        link.setAttribute("download", `Hesabat_${new Date().toLocaleDateString()}.csv`);
        link.click();
    };

    function clearData() { 
        if(confirm("Bütün məlumatlar silinsin?")) { 
            localStorage.clear(); 
            location.reload(); 
        } 
    }

    document.getElementById('search').oninput = filterM;
    const saved = localStorage.getItem('lastC'); 
    if(saved) process(JSON.parse(saved), false); else setInitialLocation();
</script>
</body>
</html>
